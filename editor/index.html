<!DOCTYPE html>
<!-- Yes, there is no code formatting. Deal with it. -->
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Liftoff</title>
      <script src="https://unpkg.com/blockly/blockly.min.js"></script>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
      <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
      <style>
         body {
         margin: 0;
         display: flex;
         height: 100vh;
         background-color: #f9f9f9;
         font-family: arial;
         }
         #blocklyDiv {
         position: absolute;
         top: 56px; /* height of the top bar */
         left: 0;
         right: 0;
         bottom: 0;
         }
      </style>
   </head>
   <body data-bs-theme="dark">
      <noscript>Enable Javascript</noscript>
      <div class="modal fade" id="smModal" tabindex="-1" aria-labelledby="smModalLabel" aria-hidden="true">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h1 class="modal-title fs-5" id="smModalLabel">Sprite Manager</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                  <iframe src="https://liftoffcoding.top/editor/spritemanager.html" width="100%" height="100%"></iframe>
               </div>
               <div class="modal-footer">
               </div>
            </div>
         </div>
      </div>
      <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top">
         <div class="container-fluid">
            <a class="navbar-brand" href="https://liftoffcoding.top">Liftoff</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
               <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                  <li class="nav-item dropdown">
                     <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                     File
                     </a>
                     <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="location.reload()">New</a></li>
                        <li><a class="dropdown-item" href="#" onclick="generateProject()">Save</a></li>
                        <li><a class="dropdown-item" href="#" onclick="readProject()">Load</a></li>
                     </ul>
                  </li>
                  <li class="nav-item dropdown">
                     <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                     Edit
                     </a>
                     <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" aria-disabled="false" data-bs-toggle="modal" data-bs-target="#smModal">Sprites</a></li>
                        <li><a class="dropdown-item" href="#" aria-disabled="true">Settings</a></li>
                        <li><a class="dropdown-item" href="#" aria-disabled="true">Plugins</a></li>
                     </ul>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="#" onclick="execute()">Run</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="#" onclick="toggledebug()">Debug</a>
                  </li>
               </ul>
               <input class="form-control me-2" id="pname" placeholder="Project Name" aria-label="Name">
            </div>
         </div>
      </nav>
      <br>
      <div id="blocklyDiv"></div>
      <xml id="toolbox" style="display: none">
         <category name="Logic" colour="#5b80a5">
            <block type="controls_if"></block>
            <block type="logic_compare">
               <field name="OP">EQ</field>
            </block>
            <block type="logic_operation">
               <field name="OP">AND</field>
            </block>
            <block type="logic_negate"></block>
            <block type="logic_boolean">
               <field name="BOOL">TRUE</field>
            </block>
            <block type="logic_null"></block>
            <block type="logic_ternary"></block>
         </category>
         <category name="Controls" colour="#5ba55b">
            <block type="controls_repeat_ext">
               <value name="TIMES">
                  <shadow type="math_number">
                     <field name="NUM">10</field>
                  </shadow>
               </value>
            </block>
            <block type="controls_whileUntil">
               <field name="MODE">WHILE</field>
            </block>
            <block type="controls_for">
               <field name="VAR" id="z`0CBwC|A]]DBad3SthZ">i</field>
               <value name="FROM">
                  <shadow type="math_number">
                     <field name="NUM">1</field>
                  </shadow>
               </value>
               <value name="TO">
                  <shadow type="math_number">
                     <field name="NUM">10</field>
                  </shadow>
               </value>
               <value name="BY">
                  <shadow type="math_number">
                     <field name="NUM">1</field>
                  </shadow>
               </value>
            </block>
            <block type="controls_forEach">
               <field name="VAR" id="L*Ii@0*!F+N$b-l|}+Ey">j</field>
            </block>
            <block type="controls_flow_statements">
               <field name="FLOW">BREAK</field>
            </block>
         </category>
         <category name="Numbers" colour="#5b67a5">
            <block type="math_number">
               <field name="NUM">0</field>
            </block>
            <block type="math_arithmetic">
               <field name="OP">ADD</field>
               <value name="A">
                  <shadow type="math_number">
                     <field name="NUM">1</field>
                  </shadow>
               </value>
               <value name="B">
                  <shadow type="math_number">
                     <field name="NUM">1</field>
                  </shadow>
               </value>
            </block>
            <block type="math_single">
               <field name="OP">ROOT</field>
               <value name="NUM">
                  <shadow type="math_number">
                     <field name="NUM">9</field>
                  </shadow>
               </value>
            </block>
            <block type="math_trig">
               <field name="OP">SIN</field>
               <value name="NUM">
                  <shadow type="math_number">
                     <field name="NUM">45</field>
                  </shadow>
               </value>
            </block>
            <block type="math_constant">
               <field name="CONSTANT">PI</field>
            </block>
            <block type="math_number_property">
               <mutation divisor_input="false"/>
               <field name="PROPERTY">EVEN</field>
               <value name="NUMBER_TO_CHECK">
                  <shadow type="math_number">
                     <field name="NUM">0</field>
                  </shadow>
               </value>
            </block>
            <block type="math_round">
               <field name="OP">ROUND</field>
               <value name="NUM">
                  <shadow type="math_number">
                     <field name="NUM">3.1</field>
                  </shadow>
               </value>
            </block>
            <block type="math_on_list">
               <mutation op="SUM"/>
               <field name="OP">SUM</field>
            </block>
            <block type="math_modulo">
               <value name="DIVIDEND">
                  <shadow type="math_number">
                     <field name="NUM">64</field>
                  </shadow>
               </value>
               <value name="DIVISOR">
                  <shadow type="math_number">
                     <field name="NUM">10</field>
                  </shadow>
               </value>
            </block>
            <block type="math_constrain">
               <value name="VALUE">
                  <shadow type="math_number">
                     <field name="NUM">50</field>
                  </shadow>
               </value>
               <value name="LOW">
                  <shadow type="math_number">
                     <field name="NUM">1</field>
                  </shadow>
               </value>
               <value name="HIGH">
                  <shadow type="math_number">
                     <field name="NUM">100</field>
                  </shadow>
               </value>
            </block>
            <block type="math_random_int">
               <value name="FROM">
                  <shadow type="math_number">
                     <field name="NUM">1</field>
                  </shadow>
               </value>
               <value name="TO">
                  <shadow type="math_number">
                     <field name="NUM">100</field>
                  </shadow>
               </value>
            </block>
            <block type="math_random_float"/>
         </category>
         <category name="Text" colour="#5ba58c">
            <block type="text">
               <field name="TEXT"/>
            </block>
            <block type="text_join">
               <mutation items="2"/>
            </block>
            <block type="text_append">
               <field name="VAR" id="/d2.l{Nh`}49Gyy#1uKY">item</field>
               <value name="TEXT">
                  <shadow type="text">
                     <field name="TEXT"/>
                  </shadow>
               </value>
            </block>
            <block type="text_length">
               <value name="VALUE">
                  <shadow type="text">
                     <field name="TEXT">abc</field>
                  </shadow>
               </value>
            </block>
            <block type="text_isEmpty">
               <value name="VALUE">
                  <shadow type="text">
                     <field name="TEXT"/>
                  </shadow>
               </value>
            </block>
            <block type="text_indexOf">
               <field name="END">FIRST</field>
               <value name="VALUE">
                  <block type="variables_get">
                     <field name="VAR" id="ph6wwYeV_YEB:8Eegl;P">text</field>
                  </block>
               </value>
               <value name="FIND">
                  <shadow type="text">
                     <field name="TEXT">abc</field>
                  </shadow>
               </value>
            </block>
            <block type="text_charAt">
               <mutation at="true"/>
               <field name="WHERE">FROM_START</field>
               <value name="VALUE">
                  <block type="variables_get">
                     <field name="VAR" id="ph6wwYeV_YEB:8Eegl;P">text</field>
                  </block>
               </value>
            </block>
            <block type="text_getSubstring">
               <mutation at1="true" at2="true"/>
               <field name="WHERE1">FROM_START</field>
               <field name="WHERE2">FROM_START</field>
               <value name="STRING">
                  <block type="variables_get">
                     <field name="VAR" id="ph6wwYeV_YEB:8Eegl;P">text</field>
                  </block>
               </value>
            </block>
            <block type="text_changeCase">
               <field name="CASE">UPPERCASE</field>
               <value name="TEXT">
                  <shadow type="text">
                     <field name="TEXT">abc</field>
                  </shadow>
               </value>
            </block>
            <block type="text_trim">
               <field name="MODE">BOTH</field>
               <value name="TEXT">
                  <shadow type="text">
                     <field name="TEXT">abc</field>
                  </shadow>
               </value>
            </block>
            <block type="text_print">
               <value name="TEXT">
                  <shadow type="text">
                     <field name="TEXT">abc</field>
                  </shadow>
               </value>
            </block>
            <block type="text_prompt_ext">
               <mutation type="TEXT"/>
               <field name="TYPE">TEXT</field>
               <value name="TEXT">
                  <shadow type="text">
                     <field name="TEXT">abc</field>
                  </shadow>
               </value>
            </block>
         </category>
         <category name="Variables" colour="#a55b80" custom="VARIABLE"></category>
         <category name="Lists" colour="#745ba5">
            <block type="lists_create_with">
               <mutation items="0"/>
            </block>
            <block type="lists_create_with">
               <mutation items="3"/>
            </block>
            <block type="lists_repeat">
               <value name="NUM">
                  <shadow type="math_number">
                     <field name="NUM">5</field>
                  </shadow>
               </value>
            </block>
            <block type="lists_length"/>
            <block type="lists_isEmpty"/>
            <block type="lists_indexOf">
               <field name="END">FIRST</field>
               <value name="VALUE">
                  <block type="variables_get">
                     <field name="VAR" id="_c[[v:_1iobROC~f5w_2">list</field>
                  </block>
               </value>
            </block>
            <block type="lists_getIndex">
               <mutation statement="false" at="true"/>
               <field name="MODE">GET</field>
               <field name="WHERE">FROM_START</field>
               <value name="VALUE">
                  <block type="variables_get">
                     <field name="VAR" id="_c[[v:_1iobROC~f5w_2">list</field>
                  </block>
               </value>
            </block>
            <block type="lists_setIndex">
               <mutation at="true"/>
               <field name="MODE">SET</field>
               <field name="WHERE">FROM_START</field>
               <value name="LIST">
                  <block type="variables_get">
                     <field name="VAR" id="_c[[v:_1iobROC~f5w_2">list</field>
                  </block>
               </value>
            </block>
            <block type="lists_getSublist">
               <mutation at1="true" at2="true"/>
               <field name="WHERE1">FROM_START</field>
               <field name="WHERE2">FROM_START</field>
               <value name="LIST">
                  <block type="variables_get">
                     <field name="VAR" id="_c[[v:_1iobROC~f5w_2">list</field>
                  </block>
               </value>
            </block>
            <block type="lists_split">
               <mutation mode="SPLIT"/>
               <field name="MODE">SPLIT</field>
               <value name="DELIM">
                  <shadow type="text">
                     <field name="TEXT">,</field>
                  </shadow>
               </value>
            </block>
            <block type="lists_sort">
               <field name="TYPE">NUMERIC</field>
               <field name="DIRECTION">1</field>
            </block>
         </category>
         <category name="Functions" colour="#995ba5" custom="PROCEDURE"></category>
         <sep></sep>
         <category name="Game" colour=315>
            <block type="sprite">
               <field name="CODE"></field>
            </block>
            <block type="spriteget">
               <field name="CODE"></field>
            </block>
            </block>
         </category>
         <category name="Raw" colour="#494949">
            <button text="Read me first!" callbackKey="rawNotice"></button>
            <block type="raw_block">
               <field name="CODE"></field>
            </block>
            <block type="raw_value">
               <field name="CODE"></field>
            </block>
            </block>
         </category>
         <sep></sep>
      </xml>
      <script>
         if (window.location.host == "https://api.allorigins.win" || window.location.host == "https://corsproxy.io") {
            alert("Currently, Specific features on Liftoff (Like the sprite manager) will not work if liftoffcoding.top is blocked by your network administrator. Please contact your IT/Admin about unblocking liftoff.")
         };
         let debug = false;
         let sprites = []
         function toggledebug() {
            if(debug){
               alert("Debug is now off")
               debug = false
            } else {
               alert("Debug is now on")
               debug = true
            };
         };
         Blockly.Blocks['raw_value'] = {
           init: function() {
             this.appendValueInput("CODE")
                 .setCheck(null)
                 .appendField("raw");
             this.setOutput(true, null);
             this.setColour("#494949");
             this.setTooltip("");
             this.setHelpUrl("");
           }
         };
         Blockly.Blocks['raw_block'] = {
           init: function() {
             this.appendValueInput("CODE")
             .setCheck(null)
             .appendField("raw");
             this.setPreviousStatement(true, null);
             this.setNextStatement(true, null);
             this.setColour("#494949");
             this.setTooltip("");
             this.setHelpUrl("");
           }
         };
         Blockly.Blocks['sprite'] = {
           init: function() {
              this.appendValueInput("NAME")
                 .setCheck(["String", "Number"])
                 .appendField("set sprite #")
                 .appendField(new Blockly.FieldNumber(0, 0), "SPRITE")
                 .appendField("'s")
                 .appendField(new Blockly.FieldDropdown([["x","x"], ["y","y"], ["size","size"], ["animation","anim"], ["opacity","opacity"]]), "ATT")
                 .appendField("to");
             this.setPreviousStatement(true, null);
             this.setNextStatement(true, null);
             this.setColour(315);
             this.setTooltip("");
             this.setHelpUrl("");
         }
         };
         Blockly.Blocks['spriteget'] = {
         init: function() {
         this.appendDummyInput()
         .appendField("get sprite #")
         .appendField(new Blockly.FieldNumber(0, 0), "SPRITE")
         .appendField("'s")
         .appendField(new Blockly.FieldDropdown([["x","x"], ["y","y"], ["size","size"], ["animation","anim"], ["opacity","opacity"]]), "ATT");
         this.setOutput(true, null);
         this.setColour(315);
         this.setTooltip("");
         this.setHelpUrl("");
         }
         };
         function spritesToPhaser(){
            
         }
         javascript.javascriptGenerator.forBlock['spriteget'] = function(block, generator) {
         var number_sprite = block.getFieldValue('SPRITE');
         var dropdown_att = block.getFieldValue('ATT');
         // TODO: Assemble javascript into code variable.
         var code = `sprite[${number_sprite}].${dropdown_att}`;
         // TODO: Change ORDER_NONE to the correct strength.
         return [code, Blockly.javascript.ORDER_MEMBER];
         };
         javascript.javascriptGenerator.forBlock['sprite'] = function(block, generator) {
         var number_sprite = block.getFieldValue('SPRITE');
         var dropdown_att = block.getFieldValue('ATT');
         var value_name = generator.valueToCode(block, 'NAME', javascript.Order.ATOMIC);
         // TODO: Assemble javascript into code variable.
         var code = `sprites[${number_sprite}].${dropdown_att} = ${value_name}\n`;
         return code;
         };
         javascript.javascriptGenerator.forBlock['raw_block'] = function(block, generator) {
           var value_code = generator.valueToCode(block, 'CODE', javascript.Order.ATOMIC);
           // TODO: Assemble javascript into code variable.
           var code = value_code + '\n';
           return code;
         };
         javascript.javascriptGenerator.forBlock['raw_value'] = function(block, generator) {
           var value_code = generator.valueToCode(block, 'CODE', javascript.Order.ATOMIC);
           // TODO: Assemble javascript into code variable.
           var code = value_code;
           // TODO: Change ORDER_NONE to the correct strength.
           return [code, Blockly.javascript.ORDER_MEMBER];
         };
         function execute(){
            const code = `
            const config = {
                    type: Phaser.AUTO,
                    width: 320,
                    height: 240,
                    backgroundColor: "#000000",
                    scene: {
                       preload: function () {
                          const loadTxt = this.add.text(80,100,'Loading...', {font: "16px Arial", fill: "#ffffff"});
                       },
                       create: function () {
                          this.cameras.main.setBackgroundColor("#ffffff");
                          document.body.appendChild(Object.assign(document.createElement('script'), {text: ${javascript.javascriptGenerator.workspaceToCode(workspace).replace(/^'(.*)'$/, '`$1`')}}));
                       }
                    },
                    physics: {
                                 default: 'arcade',
                                 arcade: {
                                                 gravity: { y: 200 }
                                 }
                             }
            };
            const game = new Phaser.Game(config);
            `
            if(debug){
               alert("Debug: "+removeSurroundingQuotes(code));
            };
            openBase64InNewTab(btoa(
              `<html><head><title>My project</title>
              <style>body {background-color: black;}</style><script src="https://cdn.jsdelivr.net/npm/phaser@3.86.0/dist/phaser.min.js"><\/script></head>
              <body>
              <script>${code}<\/script>
              <noscript style="color: red;">You need JavaScript to play this game.</noscript>
              </body></html>`
          ), "text/html");
         }
         function removeSurroundingQuotes(str) {
             if ((str.startsWith('"') && str.endsWith('"')) || (str.startsWith("'") && str.endsWith("'")) || (str.startsWith("\`") && str.endsWith("\`"))) {
                 return str.slice(1, -1);
             }
             return str;
         }
         
         function openBase64InNewTab(data, mimeType) {
            var byteCharacters = atob(data);
            var byteNumbers = new Array(byteCharacters.length);
         
            for (var i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
         
            var byteArray = new Uint8Array(byteNumbers);
         
            var file = new Blob([byteArray], {
               type: mimeType + ";base64",
            });
         
            var fileURL = URL.createObjectURL(file);
         
            window.open(fileURL, "_blank");
         }
         const workspace = Blockly.inject('blocklyDiv', {
             toolbox: document.getElementById('toolbox'),
             renderer: 'zelos', // Scratch-like blocks
             theme: Blockly.Themes.Classic,
             zoom : {
             	controls : true,
             	wheel : true,
             	startScale : 1,
             	maxScale : 3,
             	minScale : 0.3,
               scaleSpeed : 1.2
             }
         });
         workspace.registerButtonCallback("rawNotice", rawNotice)
         function rawNotice(button){
            alert("If your code has raw blocks and publishing your game on Liftoff services, your game must be manually verified and anything that could be harmful to the player will result in the game being denied. Use raw blocks only when necessary.")
         }
         async function generateProject() {
         const zip = new JSZip();
         zip.file("sprites.txt", JSON.stringify(sprites));
         zip.file("code.json", JSON.stringify(Blockly.serialization.workspaces.save(workspace)));
         const blob = await zip.generateAsync({ type: "blob" });
         await saveZipBlob(blob, `${document.getElementById("pname").value}.liftoff`);
         }
         async function saveZipBlob(zipBlob, suggestedName = "project.liftoff") {
         try {
         const fileHandle = await window.showSaveFilePicker({
         suggestedName,
         types: [
         {
          description: "Liftoff Project",
          accept: { "application/x-liftoff-project": [".liftoff"] },
         },
         ],
         });
         
         const writable = await fileHandle.createWritable();
         await writable.write(zipBlob);
         await writable.close();
         
         console.log("ZIP file saved:", suggestedName);
         } catch (err) {
         console.error("Save cancelled or failed:", err);
         }
         }
         async function loadZipBlob() {
         try {
         const [fileHandle] = await window.showOpenFilePicker({
         types: [
         {
          description: "Liftoff Project",
          accept: { "application/x-liftoff-project": [".liftoff"] },
         },
         ],
         multiple: false,
         });
         
         const file = await fileHandle.getFile();
         const zipData = await file.arrayBuffer();
         
         const zip = await JSZip.loadAsync(zipData);
         console.log("ZIP loaded. Files inside:");
         
         zip.forEach((relativePath, file) => {
         console.log(relativePath);
         });
         
         return zip; // You can use zip.file('some.txt').async('text') to read individual files
         } catch (err) {
         console.error("Loading ZIP failed or cancelled:", err);
         return null;
         }
         }
         
         async function readProject() {
         const zip = await loadZipBlob();
         if (!zip) return;
         
         if (zip.files['sprites.txt']) {
         sprites = await zip.file('sprites.txt').async('text');
         document.getElementById('sm').contentWindow.postMessage(sprites, '*')
         if (zip.files['code.json']) {
         // I handled this like absolute dogshit but oh well
         let tempcode1 = await zip.file('code.json').async('text');
         Blockly.serialization.workspaces.load(JSON.parse(tempcode1), workspace);
         } else {
         alert("code.json not found.");
         }
         } else {
         alert("sprites.txt not found.");
         }
         }
         
         
      </script>
   </body>
</html>
